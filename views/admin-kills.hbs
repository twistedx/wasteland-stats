<section id="admin-section">
  {{> admin-nav}}

  <form class="filter-bar" method="GET" action="/admin/kills">
    <input
      type="text"
      name="search"
      class="filter-input"
      placeholder="Search player by name..."
      value="{{search}}"
    >
    <select name="sort" class="filter-select">
      <option value="kills" {{#if (eq sort 'kills')}}selected{{/if}}>Sort: Kills</option>
      <option value="deaths" {{#if (eq sort 'deaths')}}selected{{/if}}>Sort: Deaths</option>
      <option value="kd" {{#if (eq sort 'kd')}}selected{{/if}}>Sort: K/D</option>
      <option value="id" {{#if (eq sort 'id')}}selected{{/if}}>Sort: Killer ID</option>
    </select>
    <button type="submit" class="btn btn-admin">Search</button>
  </form>

  {{#if killsError}}
    <div class="error">Failed to load kill stats. Please try again.</div>
  {{else}}
    <p class="result-count">{{playerCount}} player{{#unless (eq playerCount 1)}}s{{/unless}} found{{#if search}} for "{{search}}"{{/if}}</p>

    {{#if players.length}}
      <!-- Desktop table -->
      <div class="table-scroll kills-table-desktop">
        <table id="kills-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Killer ID</th>
              <th>Kills</th>
              <th>Deaths</th>
              <th>K/D</th>
              <th>Most Killed</th>
              <th>Nemesis</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {{#each players}}
              <tr>
                <td class="player-name">{{this.arma_username}}</td>
                <td class="guid">{{this.arma_id}}</td>
                <td>{{this.kill_count}}</td>
                <td>{{this.deaths}}</td>
                <td>{{this.kdRatio}}</td>
                <td>{{this.mostKilled}} ({{this.mostKilledCount}})</td>
                <td>{{this.mostKilledBy}} ({{this.mostKilledByCount}})</td>
                <td>
                  <a
                    href="/admin/kills?arma_id={{this.arma_id}}&username={{encodeURI this.arma_username}}"
                    class="btn btn-admin btn-small"
                  >View Kills</a>
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>

      <!-- Mobile accordion -->
      <div class="kills-accordion-mobile">
        {{#each players}}
          <div class="kill-card">
            <div class="kill-card-header" onclick="this.parentElement.classList.toggle('open')">
              <span class="kill-card-name">{{this.arma_username}}</span>
              <div class="kill-card-right">
                <span class="kill-card-kd">{{this.kdRatio}} K/D</span>
                <svg class="kill-card-chevron" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
              </div>
            </div>
            <div class="kill-card-body">
              <div class="kill-card-row">
                <span class="kill-card-label">Killer ID</span>
                <span class="guid">{{this.arma_id}}</span>
              </div>
              <div class="kill-card-row">
                <span class="kill-card-label">Kills</span>
                <span>{{this.kill_count}}</span>
              </div>
              <div class="kill-card-row">
                <span class="kill-card-label">Deaths</span>
                <span>{{this.deaths}}</span>
              </div>
              <div class="kill-card-row">
                <span class="kill-card-label">K/D Ratio</span>
                <span>{{this.kdRatio}}</span>
              </div>
              <div class="kill-card-row">
                <span class="kill-card-label">Most Killed</span>
                <span>{{this.mostKilled}} ({{this.mostKilledCount}})</span>
              </div>
              <div class="kill-card-row">
                <span class="kill-card-label">Nemesis</span>
                <span>{{this.mostKilledBy}} ({{this.mostKilledByCount}})</span>
              </div>
              <div class="kill-card-row" style="padding-top:0.6rem;">
                <a
                  href="/admin/kills?arma_id={{this.arma_id}}&username={{encodeURI this.arma_username}}"
                  class="btn btn-admin btn-small"
                  style="width:100%;text-align:center;"
                >View Kills</a>
              </div>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="empty-state">{{#if search}}No players match your search.{{else}}No kill data available.{{/if}}</div>
    {{/if}}
  {{/if}}

  {{#if selectedArmaId}}
    <div class="admin-form-card" style="margin-top:1.5rem;">
      <h3>Recent Kills — {{#if selectedUsername}}{{selectedUsername}}{{else}}{{selectedArmaId}}{{/if}}</h3>
      <p class="guid" style="margin-bottom:0.75rem;">Arma ID: {{selectedArmaId}}</p>
      <a href="/admin/kills" class="btn btn-admin btn-small" style="margin-bottom:1rem;display:inline-block;">Back to Kill Log</a>

      {{#if recentKillsError}}
        <div class="error">Failed to load recent kills for this player.</div>
      {{else if recentKills.length}}
        <p class="result-count">{{recentKillCount}} incident{{#unless (eq recentKillCount 1)}}s{{/unless}} in last 7 days — page {{killPage}} of {{totalPages}}</p>
        <!-- Desktop table -->
        <div class="table-scroll recent-kills-desktop">
          <table>
            <thead>
              <tr>
                <th>Role</th>
                <th>Killer</th>
                <th>Killed</th>
                <th>Server</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {{#each recentKills}}
                <tr>
                  <td>
                    {{#if (eq this.incident_role "killer")}}<span class="badge badge-kill">Kill</span>
                    {{else if (eq this.incident_role "killed")}}<span class="badge badge-death">Death</span>
                    {{else}}<span class="badge badge-both">Both</span>
                    {{/if}}
                  </td>
                  <td class="player-name">{{fallback this.killer_name "-"}}</td>
                  <td class="player-name">{{fallback this.killed_name "-"}}</td>
                  <td>{{fallback this.server_info "-"}}</td>
                  <td>{{formatDate this.time_stamp}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>

        <!-- Mobile accordion -->
        <div class="recent-kills-mobile">
          {{#each recentKills}}
            <div class="kill-card">
              <div class="kill-card-header" onclick="this.parentElement.classList.toggle('open')">
                <span class="kill-card-badge">
                  {{#if (eq this.incident_role "killer")}}<span class="badge badge-kill">Kill</span>
                  {{else if (eq this.incident_role "killed")}}<span class="badge badge-death">Death</span>
                  {{else}}<span class="badge badge-both">Both</span>
                  {{/if}}
                </span>
                <span class="kill-card-name">{{#if (eq this.incident_role "killer")}}{{fallback this.killed_name "-"}}{{else}}{{fallback this.killer_name "-"}}{{/if}}</span>
                <div class="kill-card-right">
                  <svg class="kill-card-chevron" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
                </div>
              </div>
              <div class="kill-card-body">
                <div class="kill-card-row">
                  <span class="kill-card-label">Killer</span>
                  <span>{{fallback this.killer_name "-"}}</span>
                </div>
                <div class="kill-card-row">
                  <span class="kill-card-label">Killed</span>
                  <span>{{fallback this.killed_name "-"}}</span>
                </div>
                <div class="kill-card-row">
                  <span class="kill-card-label">Server</span>
                  <span>{{fallback this.server_info "-"}}</span>
                </div>
                <div class="kill-card-row">
                  <span class="kill-card-label">Date</span>
                  <span>{{formatDate this.time_stamp}}</span>
                </div>
              </div>
            </div>
          {{/each}}
        </div>

        {{#if (gt totalPages 1)}}
          <div class="pagination">
            {{#if (gt killPage 1)}}
              <a href="/admin/kills?arma_id={{selectedArmaId}}&username={{encodeURI selectedUsername}}&page=1" class="btn btn-admin btn-small">&laquo; First</a>
              <a href="/admin/kills?arma_id={{selectedArmaId}}&username={{encodeURI selectedUsername}}&page={{subtract killPage 1}}" class="btn btn-admin btn-small">&lsaquo; Prev</a>
            {{/if}}
            <span class="pagination-info">Page {{killPage}} of {{totalPages}}</span>
            {{#if (lt killPage totalPages)}}
              <a href="/admin/kills?arma_id={{selectedArmaId}}&username={{encodeURI selectedUsername}}&page={{add killPage 1}}" class="btn btn-admin btn-small">Next &rsaquo;</a>
              <a href="/admin/kills?arma_id={{selectedArmaId}}&username={{encodeURI selectedUsername}}&page={{totalPages}}" class="btn btn-admin btn-small">Last &raquo;</a>
            {{/if}}
          </div>
        {{/if}}
      {{else}}
        <div class="empty-state">No kills found for this player in the last 7 days.</div>
      {{/if}}
    </div>
  {{/if}}

</section>

{{> ban-modal}}
